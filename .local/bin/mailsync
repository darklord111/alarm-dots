#!/bin/sh

mbsync -V smee
notmuch new
num_unread=$(notmuch count tag:unread)

new=$(find "$HOME/.local/share/mail/smee/INBOX/new/" "$HOME/.local/share/mail/smee/\[Gmail\].Important/new/" "$HOME/.local/share/mail/smee/Inbox/new/" "$HOME/.local/share/mail/smee/inbox/new/" -type f 2> /dev/null)

# Count all the new files in the 'new' directory
	notify-send " ðŸ“§ Mailbox synced. You have Mail!" "ðŸ“¬ $num_unread new messages."

for file in $new; do
	# Extract subject and sender from mail.
	from=$(awk '/^From: / && ++n ==1,/^\<.*\>:/' "$file" | perl -CS -MEncode -ne 'print decode("MIME-Header", $_)' | awk '{ $1=""; if (NF>=3)$NF=""; print $0 }' | sed 's/^[[:blank:]]*[\"'\''\<]*//;s/[\"'\''\>]*[[:blank:]]*$//')
	subject=$(awk '/^Subject: / && ++n == 1,/^\<.*\>: / && ++i == 2' "$file" | head -n 1 | perl -CS -MEncode -ne 'print decode("MIME-Header", $_)' | sed 's/^Subject: //' | sed 's/^{[[:blank:]]*[\"'\''\<]*//;s/[\"'\''\>]*[[:blank:]]*$//' | tr -d '\n')
	notify-send --app-name="mutt-wizard" " ðŸ“§  From:   $from" "Subject: $subject "
	
done

